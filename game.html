<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êó•Êú¨Ë™ûÂçòË™ûÁ∑¥Áøí„Ç≤„Éº„É† - JLPT N5~N1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #667eea);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden;
            position: relative;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(circle at 20% 30%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(255,255,255,0.05) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
            animation: containerEntry 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes containerEntry {
            0% {
                opacity: 0;
                transform: scale(0.9) translateY(30px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            color: white;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            display: block;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .stat-value.animate {
            animation: popScale 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes popScale {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .language-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 30px;
            justify-content: center;
            align-items: center;
        }

        .language-btn {
            padding: 12px 16px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            color: #667eea;
        }

        .language-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .language-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .other-languages-dropdown { position: relative; display: inline-block; }
        .other-languages-btn { padding: 12px 16px; border: 2px solid #667eea; border-radius: 10px; font-size: 0.9em; font-weight: bold; cursor: pointer; transition: all 0.3s; background: white; color: #667eea; }
        .other-languages-btn:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        .other-languages-btn.has-active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; }
        .dropdown-content { display: none; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); background: white; min-width: 150px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); border-radius: 10px; z-index: 100; margin-top: 5px; overflow: hidden; }
        .dropdown-content.show { display: block; animation: fadeIn 0.3s; }
        .dropdown-item { padding: 12px 16px; cursor: pointer; transition: all 0.2s; border: none; background: white; color: #333; font-size: 0.9em; font-weight: bold; width: 100%; text-align: left; }
        .dropdown-item:hover { background: #f0f0f0; }
        .dropdown-item.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }

        .level-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }

        .level-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: #f0f0f0;
            color: #333;
        }

        .level-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .level-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mode-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .mode-btn {
            padding: 20px;
            border: 2px solid #667eea;
            border-radius: 15px;
            background: white;
            color: #667eea;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .question-count-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }

        .count-btn {
            padding: 15px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            color: #667eea;
        }

        .count-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .count-btn.active {
            background: #667eea;
            color: white;
        }

        .game-area {
            display: none;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .game-area.active {
            display: block;
        }

        .card {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            padding: 60px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card:hover {
            transform: scale(1.02) rotateY(5deg);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .card.flip {
            animation: cardFlip 0.6s ease-in-out;
        }

        @keyframes cardFlip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(90deg); }
            100% { transform: rotateY(0deg); }
        }

        .japanese-word {
            font-size: 4em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        .reading {
            font-size: 1.5em;
            color: #555;
            margin-bottom: 10px;
        }

        .meaning {
            font-size: 1.8em;
            color: #333;
            font-weight: 500;
        }

        .options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .option-btn {
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            cursor: pointer;
            background: #f0f0f0;
            color: #333;
            transition: all 0.3s;
            font-weight: 500;
            opacity: 0;
            transform: translateY(20px);
            animation: slideInUp 0.4s ease forwards;
            position: relative;
            overflow: hidden;
        }

        .option-btn:nth-child(1) { animation-delay: 0.1s; }
        .option-btn:nth-child(2) { animation-delay: 0.2s; }
        .option-btn:nth-child(3) { animation-delay: 0.3s; }
        .option-btn:nth-child(4) { animation-delay: 0.4s; }

        @keyframes slideInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .option-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .option-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .option-btn:hover {
            background: #e0e0e0;
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .option-btn.correct {
            background: #4caf50 !important;
            color: white;
            animation: correctPulse 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.6);
        }

        .option-btn.wrong {
            background: #f44336 !important;
            color: white;
            animation: shake 0.5s;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            30% { transform: scale(1.15); box-shadow: 0 0 50px rgba(76, 175, 80, 0.8); }
            50% { transform: scale(1.1) rotate(3deg); }
            70% { transform: scale(1.15) rotate(-3deg); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }

        /* Particle effects */
        .particle {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ffd700;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
        }

        @keyframes particle-burst {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        /* Combo indicator */
        .combo-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5em;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8),
                         0 0 40px rgba(255, 215, 0, 0.6);
            pointer-events: none;
            z-index: 9999;
            animation: comboAppear 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes comboAppear {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -80%) scale(1);
            }
        }

        .input-area {
            margin-bottom: 20px;
        }

        .answer-input {
            width: 100%;
            padding: 20px;
            font-size: 1.5em;
            border: 3px solid #667eea;
            border-radius: 15px;
            text-align: center;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .feedback {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: bold;
            display: none;
        }

        .feedback.correct {
            background: #4caf50;
            color: white;
            display: block;
            animation: fadeIn 0.5s;
        }

        .feedback.wrong {
            background: #f44336;
            color: white;
            display: block;
            animation: fadeIn 0.5s;
        }

        .progress-bar {
            width: 100%;
            height: 40px;
            background: #f0f0f0;
            border-radius: 15px;
            margin-bottom: 30px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-bar::before {
            content: attr(data-text);
            position: absolute;
            z-index: 2;
            color: #667eea;
            font-weight: bold;
            font-size: 1.1em;
            white-space: nowrap;
            transition: color 0.3s;
        }

        .progress-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
            border-radius: 15px;
            z-index: 1;
        }

        .progress-bar[data-progress]:not([data-progress="0%"])::before {
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .start-screen {
            text-align: center;
        }

        .start-screen h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .start-screen p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.2em;
            line-height: 1.6;
        }

        .result-screen {
            display: none;
            text-align: center;
        }

        .result-screen.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        .result-score {
            font-size: 5em;
            color: #667eea;
            font-weight: bold;
            margin: 30px 0;
        }

        .result-message {
            font-size: 1.8em;
            color: #555;
            margin-bottom: 30px;
        }

        .hidden {
            display: none;
        }

        .home-btn {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 20px;
            transition: all 0.3s;
            font-weight: bold;
        }

        .home-btn:hover {
            background: #5a6fd6;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="home-btn">‚Üê „Éõ„Éº„É†„Å∏Êàª„Çã</a>
        <h1 id="pageTitle">üéå Êó•Êú¨Ë™ûÂçòË™ûÁ∑¥Áøí„Ç≤„Éº„É†</h1>

        <div class="stats">
            <div class="stat-item">
                <span class="stat-value" id="score">0</span>
                <span class="stat-label">„Çπ„Ç≥„Ç¢</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="correct">0</span>
                <span class="stat-label">Ê≠£Ëß£</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="wrong">0</span>
                <span class="stat-label">‰∏çÊ≠£Ëß£</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="streak">0</span>
                <span class="stat-label">ÈÄ£Á∂ö</span>
            </div>
        </div>

        <div class="start-screen" id="startScreen">
            <h2>Ë®ÄË™û„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ / Choose Language</h2>
            <div class="language-selector" id="languageSelector">
                <button class="language-btn active" data-lang="zh">üá®üá≥ ‰∏≠Êñá</button>
                <button class="language-btn" data-lang="en">üá¨üáß EN</button>
                <button class="language-btn" data-lang="ne">üá≥üáµ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä</button>
                <button class="language-btn" data-lang="vi">üáªüá≥ VI</button>
                <button class="language-btn" data-lang="my">üá≤üá≤ ·Äô·Äº·Äî·Ä∫·Äô·Ä¨</button>
                <button class="language-btn" data-lang="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</button>
                <div class="other-languages-dropdown">
                    <button class="other-languages-btn" id="otherLangBtn">„Åù„ÅÆ‰ªñ ‚ñº</button>
                    <div class="dropdown-content" id="dropdownContent">
                        <button class="dropdown-item" data-lang="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
                        <button class="dropdown-item" data-lang="es">üá™üá∏ Espa√±ol</button>
                        <button class="dropdown-item" data-lang="de">üá©üá™ Deutsch</button>
                        <button class="dropdown-item" data-lang="fr">üá´üá∑ Fran√ßais</button>
                    </div>
                </div>
            </div>

            <h2 id="levelTitle">„É¨„Éô„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
            <div class="level-selector" id="levelSelector">
                <!-- Levels will be dynamically generated based on category -->
            </div>

            <h2>ÂïèÈ°åÊï∞„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
            <div class="question-count-selector" id="questionCountSelector">
                <button class="count-btn active" data-count="10">10Âïè</button>
                <button class="count-btn" data-count="20">20Âïè</button>
                <button class="count-btn" data-count="50">50Âïè</button>
                <button class="count-btn" data-count="100">100Âïè</button>
                <button class="count-btn" data-count="all">ÂÖ®ÈÉ®</button>
            </div>

            <h2>„Ç≤„Éº„É†„É¢„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
            <p>Â•Ω„Åç„Å™Á∑¥ÁøíÊñπÊ≥ï„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑÔºÅ</p>
            <div class="mode-selector">
                <button class="mode-btn" data-mode="flashcard">
                    üìù „Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ<br>
                    <small>ÂçòË™û„ÇíË¶ã„Å¶ÊÑèÂë≥„ÇíË¶ö„Åà„Çã</small>
                </button>
                <button class="mode-btn" data-mode="choice">
                    ‚úÖ Â§öËÇ¢ÈÅ∏Êäû<br>
                    <small>Ê≠£„Åó„ÅÑÊÑèÂë≥„ÇíÈÅ∏„Å∂</small>
                </button>
                <button class="mode-btn" data-mode="typing">
                    ‚å®Ô∏è „Çø„Ç§„Éî„É≥„Ç∞<br>
                    <small>Ë™≠„ÅøÊñπ„ÇíÂÖ•Âäõ„Åô„Çã</small>
                </button>
            </div>
        </div>

        <div class="game-area" id="gameArea">
            <div class="progress-bar" data-text="0/10" data-progress="0%">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="feedback" id="feedback"></div>

            <div class="card" id="card">
                <div class="japanese-word" id="japaneseWord">Ê∫ñÂÇô‰∏≠...</div>
                <div class="reading" id="reading"></div>
                <div class="meaning" id="meaning"></div>
            </div>

            <div class="options" id="options"></div>

            <div class="input-area hidden" id="inputArea">
                <input type="text" class="answer-input" id="answerInput" placeholder="Ë™≠„ÅøÊñπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
            </div>

            <div class="controls">
                <button class="btn btn-primary" id="nextBtn">Ê¨°„Å∏</button>
                <button class="btn btn-secondary" id="backBtn">Êàª„Çã</button>
            </div>
        </div>

        <div class="result-screen" id="resultScreen">
            <h2>üéâ „ÅäÁñ≤„ÇåÊßò„Åß„Åó„ÅüÔºÅ</h2>
            <div class="result-score" id="resultScore">0%</div>
            <div class="result-message" id="resultMessage">Great job!</div>
            <div class="controls">
                <button class="btn btn-primary" id="retryBtn">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
                <button class="btn btn-secondary" id="homeBtn">„Éõ„Éº„É†„Å∏</button>
            </div>
        </div>
    </div>

    <script>
        // ========== Sound System using Web Audio API ==========
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioCtx();
            }
            return audioCtx;
        }

        // Play correct answer sound (cheerful ascending notes)
        function playCorrectSound() {
            const ctx = initAudio();
            const now = ctx.currentTime;

            // Play cheerful ascending notes
            [523.25, 659.25, 783.99].forEach((freq, i) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.3, now + i * 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.1 + 0.2);
                osc.start(now + i * 0.1);
                osc.stop(now + i * 0.1 + 0.25);
            });
        }

        // Play wrong answer sound (descending buzz)
        function playWrongSound() {
            const ctx = initAudio();
            const now = ctx.currentTime;

            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'square';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.exponentialRampToValueAtTime(100, now + 0.3);
            gain.gain.setValueAtTime(0.15, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.35);
        }

        // Play combo sound (exciting rising arpeggio)
        function playComboSound(comboCount) {
            const ctx = initAudio();
            const now = ctx.currentTime;

            const baseFreq = 440 + (comboCount * 20);
            [1, 1.25, 1.5, 2].forEach((mult, i) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'triangle';
                osc.frequency.value = baseFreq * mult;
                gain.gain.setValueAtTime(0.25, now + i * 0.05);
                gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.05 + 0.15);
                osc.start(now + i * 0.05);
                osc.stop(now + i * 0.05 + 0.2);
            });
        }

        // Play game complete sound (victory fanfare)
        function playGameCompleteSound(percentage) {
            const ctx = initAudio();
            const now = ctx.currentTime;

            // Victory fanfare melody
            const melody = percentage >= 80
                ? [523.25, 659.25, 783.99, 1046.5]  // C5-E5-G5-C6 (victory)
                : [392, 349.23, 329.63, 293.66];    // G4-F4-E4-D4 (try again)

            melody.forEach((freq, i) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = percentage >= 80 ? 'sine' : 'triangle';
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.3, now + i * 0.15);
                gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.15 + 0.3);
                osc.start(now + i * 0.15);
                osc.stop(now + i * 0.15 + 0.35);
            });

            // Add a final chord for perfect scores
            if (percentage === 100) {
                setTimeout(() => {
                    const ctx2 = initAudio();
                    const now2 = ctx2.currentTime;
                    [523.25, 659.25, 783.99, 1046.5].forEach((freq) => {
                        const osc = ctx2.createOscillator();
                        const gain = ctx2.createGain();
                        osc.connect(gain);
                        gain.connect(ctx2.destination);
                        osc.type = 'sine';
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0.2, now2);
                        gain.gain.exponentialRampToValueAtTime(0.01, now2 + 0.8);
                        osc.start(now2);
                        osc.stop(now2 + 0.85);
                    });
                }, 700);
            }
        }

        // Play click sound
        function playClickSound() {
            const ctx = initAudio();
            const now = ctx.currentTime;
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.value = 800;
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
            osc.start(now);
            osc.stop(now + 0.06);
        }

        // ========== End Sound System ==========

        // Get category from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const currentCategory = urlParams.get('category') || 'JLPT';

        // Category configurations
        const categoryConfig = {
            'IT': {
                title: 'üíª ITÊó•Êú¨Ë™ûÂçòË™ûÁ∑¥Áøí',
                levelTitle: 'ÂçòË™û„Çª„ÉÉ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                levels: [{ id: 'IT', name: 'ITÂçòË™û' }],
                singleLevel: true
            },
            'BJT': {
                title: 'üíº „Éì„Ç∏„Éç„ÇπÊó•Êú¨Ë™ûÁ∑¥Áøí',
                levelTitle: 'ÂçòË™û„Çª„ÉÉ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                levels: [{ id: 'BJT', name: 'BJTÂçòË™û' }],
                singleLevel: true
            },
            'JLPT': {
                title: 'üéå JLPTÂçòË™ûÁ∑¥Áøí„Ç≤„Éº„É†',
                levelTitle: '„É¨„Éô„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                levels: [
                    { id: 'N5', name: 'N5' },
                    { id: 'N4', name: 'N4' },
                    { id: 'N3', name: 'N3' },
                    { id: 'N2', name: 'N2' },
                    { id: 'N1', name: 'N1' }
                ],
                singleLevel: false
            }
        };

        // Get current config
        const config = categoryConfig[currentCategory] || categoryConfig['JLPT'];

        // Vocabulary storage (loaded from JSON files)
        const vocabulary = {};

        // Function to load vocabulary from JSON files
        async function loadVocabulary(level) {
            if (vocabulary[level]) {
                return vocabulary[level]; // Already loaded
            }

            try {
                const response = await fetch(`vocabulary/${level}.json`);
                if (!response.ok) {
                    throw new Error(`Failed to load vocabulary for ${level}`);
                }
                vocabulary[level] = await response.json();
                return vocabulary[level];
            } catch (error) {
                console.error('Error loading vocabulary:', error);
                alert(`ÂçòË™û„É™„Çπ„Éà„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${level}\n„Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                return [];
            }
        }

        // Get meaning in current language
        function getMeaning(word) {
            // If word has meanings object (multilingual)
            if (word.meanings && typeof word.meanings === 'object') {
                return word.meanings[currentLanguage] || word.meanings.en || word.meaning;
            }
            // Fallback to single meaning (old format)
            return word.meaning;
        }

        // Game state
        let currentLanguage = 'zh';
        let currentLevel = null;
        let currentMode = null;
        let currentQuestionCount = 10;
        let currentWords = [];
        let currentIndex = 0;
        let score = 0;
        let correct = 0;
        let wrong = 0;
        let streak = 0;
        let isFlipped = false;

        // DOM elements
        const startScreen = document.getElementById('startScreen');
        const gameArea = document.getElementById('gameArea');
        const resultScreen = document.getElementById('resultScreen');
        const languageSelector = document.getElementById('languageSelector');
        const levelSelector = document.getElementById('levelSelector');
        const questionCountSelector = document.getElementById('questionCountSelector');
        const card = document.getElementById('card');
        const japaneseWord = document.getElementById('japaneseWord');
        const reading = document.getElementById('reading');
        const meaning = document.getElementById('meaning');
        const options = document.getElementById('options');
        const inputArea = document.getElementById('inputArea');
        const answerInput = document.getElementById('answerInput');
        const feedback = document.getElementById('feedback');
        const progressBar = document.querySelector('.progress-bar');
        const progressFill = document.getElementById('progressFill');
        const nextBtn = document.getElementById('nextBtn');
        const backBtn = document.getElementById('backBtn');
        const retryBtn = document.getElementById('retryBtn');
        const homeBtn = document.getElementById('homeBtn');

        // Dropdown elements
        const otherLangBtn = document.getElementById('otherLangBtn');
        const dropdownContent = document.getElementById('dropdownContent');
        
        otherLangBtn.addEventListener('click', (e) => { e.stopPropagation(); dropdownContent.classList.toggle('show'); });
        document.addEventListener('click', (e) => { if (!e.target.closest('.other-languages-dropdown')) dropdownContent.classList.remove('show'); });
        
        // Language selection
        languageSelector.addEventListener('click', (e) => {
            if (e.target.classList.contains('language-btn')) {
                document.querySelectorAll('.language-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.dropdown-item').forEach(btn => btn.classList.remove('active'));
                otherLangBtn.classList.remove('has-active');
                e.target.classList.add('active');
                currentLanguage = e.target.dataset.lang;
            }
        });
        
        dropdownContent.addEventListener('click', (e) => {
            if (e.target.classList.contains('dropdown-item')) {
                e.stopPropagation();
                document.querySelectorAll('.language-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.dropdown-item').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                otherLangBtn.classList.add('has-active');
                currentLanguage = e.target.dataset.lang;
                dropdownContent.classList.remove('show');
            }
        });

        // Initialize page based on category
        function initPage() {
            // Set title
            document.getElementById('pageTitle').textContent = config.title;
            document.getElementById('levelTitle').textContent = config.levelTitle;
            document.title = config.title;

            // Generate level buttons
            const levelSelector = document.getElementById('levelSelector');
            levelSelector.innerHTML = '';

            config.levels.forEach((level, index) => {
                const btn = document.createElement('button');
                btn.className = 'level-btn';
                btn.dataset.level = level.id;
                btn.textContent = level.name;

                // Auto-select if single level category
                if (config.singleLevel && index === 0) {
                    btn.classList.add('active');
                    currentLevel = level.id;
                }

                levelSelector.appendChild(btn);
            });

            // Adjust grid for single level
            if (config.singleLevel) {
                levelSelector.style.gridTemplateColumns = '1fr';
            }
        }

        // Run initialization
        initPage();

        // Level selection
        levelSelector.addEventListener('click', (e) => {
            if (e.target.classList.contains('level-btn')) {
                document.querySelectorAll('.level-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                currentLevel = e.target.dataset.level;
            }
        });

        // Question count selection
        questionCountSelector.addEventListener('click', (e) => {
            if (e.target.classList.contains('count-btn')) {
                document.querySelectorAll('.count-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                const count = e.target.dataset.count;
                currentQuestionCount = count === 'all' ? 'all' : parseInt(count);
            }
        });

        // Mode selection
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!currentLevel) {
                    alert(config.singleLevel ? 'ÂçòË™û„Çª„ÉÉ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ' : 'ÂÖà„Å´„É¨„Éô„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ');
                    return;
                }
                currentMode = btn.dataset.mode;
                await startGame();
            });
        });

        // Start game
        async function startGame() {
            // Show loading message
            japaneseWord.textContent = 'ÂçòË™û„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...';

            // Reset stats
            score = 0;
            correct = 0;
            wrong = 0;
            streak = 0;
            currentIndex = 0;
            updateStats();

            // Load vocabulary from JSON file
            const levelWords = await loadVocabulary(currentLevel);

            if (!levelWords || levelWords.length === 0) {
                return; // Error already shown in loadVocabulary
            }

            // Determine how many questions to use
            const questionCount = currentQuestionCount === 'all'
                ? levelWords.length
                : Math.min(currentQuestionCount, levelWords.length);

            currentWords = getRandomWords(levelWords, questionCount);

            // Show game area
            startScreen.classList.add('hidden');
            gameArea.classList.add('active');
            resultScreen.classList.remove('active');

            // Load first question
            loadQuestion();
        }

        // Get random words
        function getRandomWords(words, count) {
            const shuffled = [...words].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, Math.min(count, shuffled.length));
        }

        // Load question
        function loadQuestion() {
            if (currentIndex >= currentWords.length) {
                showResults();
                return;
            }

            isFlipped = false;
            feedback.classList.remove('correct', 'wrong');
            const word = currentWords[currentIndex];

            // Update progress
            const progressPercent = ((currentIndex / currentWords.length) * 100) + '%';
            progressFill.style.width = progressPercent;
            progressBar.setAttribute('data-text', `${currentIndex + 1}/${currentWords.length}`);
            progressBar.setAttribute('data-progress', progressPercent);

            // Clear previous content
            options.innerHTML = '';
            inputArea.classList.add('hidden');
            answerInput.value = '';

            // Display based on mode
            if (currentMode === 'flashcard') {
                loadFlashcard(word);
            } else if (currentMode === 'choice') {
                loadChoice(word);
            } else if (currentMode === 'typing') {
                loadTyping(word);
            }
        }

        // Flashcard mode
        function loadFlashcard(word) {
            japaneseWord.textContent = word.word;
            reading.textContent = '';
            meaning.textContent = '„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Á≠î„Åà„ÇíË¶ã„Çã';

            card.onclick = () => {
                if (!isFlipped) {
                    // Add flip animation
                    card.classList.add('flip');
                    setTimeout(() => {
                        reading.textContent = word.reading;
                        meaning.textContent = getMeaning(word);
                        card.classList.remove('flip');
                    }, 300);
                    isFlipped = true;
                }
            };

            nextBtn.onclick = () => {
                if (isFlipped) {
                    currentIndex++;
                    loadQuestion();
                } else {
                    alert('„Åæ„ÅöÁ≠î„Åà„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ');
                }
            };
        }

        // Multiple choice mode
        function loadChoice(word) {
            japaneseWord.textContent = word.word;
            reading.textContent = word.reading;
            meaning.textContent = '';
            card.onclick = null;

            // Generate options
            const allWords = vocabulary[currentLevel];
            const wrongAnswers = allWords
                .filter(w => w.word !== word.word)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);

            const allOptions = [word, ...wrongAnswers].sort(() => Math.random() - 0.5);

            allOptions.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = getMeaning(option);
                btn.onclick = () => checkAnswer(btn, option.word === word.word, getMeaning(word));
                options.appendChild(btn);
            });

            nextBtn.onclick = () => {
                if (feedback.classList.contains('correct') || feedback.classList.contains('wrong')) {
                    currentIndex++;
                    loadQuestion();
                } else {
                    alert('Á≠î„Åà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ');
                }
            };
        }

        // Typing mode
        function loadTyping(word) {
            japaneseWord.textContent = word.word;
            reading.textContent = '';
            meaning.textContent = getMeaning(word);
            card.onclick = null;

            inputArea.classList.remove('hidden');
            answerInput.focus();

            const checkTyping = () => {
                const answer = answerInput.value.trim();
                if (answer === '') {
                    alert('Ë™≠„ÅøÊñπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ');
                    return;
                }

                const isCorrect = answer === word.reading || answer === word.word;
                if (isCorrect) {
                    feedback.textContent = `‚úì Ê≠£Ëß£ÔºÅ ${word.reading}`;
                    feedback.classList.add('correct');
                    updateScore(true);

                    // Add particle effect
                    const rect = card.getBoundingClientRect();
                    const x = rect.left + rect.width / 2;
                    const y = rect.top + rect.height / 2;
                    createParticles(x, y, 20);
                } else {
                    feedback.textContent = `‚úó ‰∏çÊ≠£Ëß£„ÄÇÊ≠£Ëß£„ÅØ ${word.reading}`;
                    feedback.classList.add('wrong');
                    updateScore(false);
                }

                setTimeout(() => {
                    currentIndex++;
                    loadQuestion();
                }, 1500);
            };

            answerInput.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    checkTyping();
                }
            };

            nextBtn.onclick = checkTyping;
        }

        // Check answer
        function checkAnswer(btn, isCorrect, correctAnswer) {
            // Disable all buttons
            document.querySelectorAll('.option-btn').forEach(b => {
                b.disabled = true;
                b.style.cursor = 'not-allowed';
            });

            if (isCorrect) {
                btn.classList.add('correct');
                feedback.textContent = '‚úì Ê≠£Ëß£ÔºÅ';
                feedback.classList.add('correct');
                updateScore(true);

                // Add particle effect
                const rect = btn.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = rect.top + rect.height / 2;
                createParticles(x, y, 20);
            } else {
                btn.classList.add('wrong');
                feedback.textContent = `‚úó ‰∏çÊ≠£Ëß£„ÄÇÊ≠£Ëß£„ÅØ ${correctAnswer}`;
                feedback.classList.add('wrong');
                updateScore(false);
            }
        }

        // Create particle effect
        function createParticles(x, y, count = 15) {
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';

                const angle = (Math.PI * 2 * i) / count;
                const velocity = 50 + Math.random() * 50;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;

                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.setProperty('--tx', tx + 'px');
                particle.style.setProperty('--ty', ty + 'px');
                particle.style.animation = 'particle-burst 1s ease-out forwards';

                const hue = Math.random() * 60 + 30;
                particle.style.background = `hsl(${hue}, 100%, 60%)`;

                document.body.appendChild(particle);

                setTimeout(() => particle.remove(), 1000);
            }
        }

        // Show combo indicator
        function showCombo(streak) {
            if (streak >= 3) {
                // Play combo sound
                playComboSound(streak);

                const combo = document.createElement('div');
                combo.className = 'combo-indicator';
                combo.textContent = `${streak} COMBO! üî•`;
                document.body.appendChild(combo);
                setTimeout(() => combo.remove(), 1000);
            }
        }

        // Animate stat value
        function animateStatValue(elementId) {
            const element = document.getElementById(elementId);
            element.classList.add('animate');
            setTimeout(() => element.classList.remove('animate'), 500);
        }

        // Update score
        function updateScore(isCorrect) {
            if (isCorrect) {
                correct++;
                streak++;
                score += 10 * streak;

                // Play correct sound
                playCorrectSound();

                // Show combo indicator for streaks
                showCombo(streak);

                // Animate score and streak
                animateStatValue('score');
                animateStatValue('streak');
                animateStatValue('correct');
            } else {
                wrong++;
                streak = 0;
                // Play wrong sound
                playWrongSound();
                animateStatValue('wrong');
            }
            updateStats();
        }

        // Update stats display
        function updateStats() {
            document.getElementById('score').textContent = score;
            document.getElementById('correct').textContent = correct;
            document.getElementById('wrong').textContent = wrong;
            document.getElementById('streak').textContent = streak;
        }

        // Show results
        function showResults() {
            gameArea.classList.remove('active');
            resultScreen.classList.add('active');

            const percentage = Math.round((correct / currentWords.length) * 100);
            document.getElementById('resultScore').textContent = percentage + '%';

            // Play game complete sound
            playGameCompleteSound(percentage);

            let message = '';
            if (percentage === 100) {
                message = 'ÂÆåÁíß„Åß„ÅôÔºÅüéâ Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅ';
            } else if (percentage >= 80) {
                message = 'Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅüëè „Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ';
            } else if (percentage >= 60) {
                message = 'ËâØ„ÅÑ„Åß„Åô„Å≠ÔºÅüí™ „ÇÇ„ÅÜÂ∞ë„ÅóÔºÅ';
            } else {
                message = 'È†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜÔºÅüìö Á∑¥Áøí„ÅÇ„Çã„ÅÆ„ÅøÔºÅ';
            }
            document.getElementById('resultMessage').textContent = message;
        }

        // Retry button
        retryBtn.onclick = async () => {
            await startGame();
        };

        // Home button
        homeBtn.onclick = () => {
            window.location.href = 'index.html';
        };

        // Back button
        backBtn.onclick = () => {
            if (confirm('„Ç≤„Éº„É†„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åô„ÅãÔºü')) {
                gameArea.classList.remove('active');
                startScreen.classList.remove('hidden');
                // Re-initialize page to reset level selection
                initPage();
                currentMode = null;
            }
        };
    </script>
</body>
</html>